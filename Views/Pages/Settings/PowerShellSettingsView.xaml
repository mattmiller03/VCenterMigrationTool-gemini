<UserControl x:Class="VCenterMigrationTool.Views.Pages.Settings.PowerShellSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:helpers="clr-namespace:VCenterMigrationTool.Helpers"
             xmlns:viewmodels="clr-namespace:VCenterMigrationTool.ViewModels.Settings"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=viewmodels:PowerShellSettingsViewModel, IsDesignTimeCreatable=False}">
    <UserControl.Resources>
        <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <helpers:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <helpers:BoolToSymbolConverter x:Key="BoolToSymbolConverter"/>
        <helpers:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <helpers:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </UserControl.Resources>
    <StackPanel>
        <TextBlock FontSize="20" FontWeight="Medium" Text="Prerequisites" />
        <TextBlock Margin="0,12,0,12" Foreground="{DynamicResource TextFillColorSecondaryBrush}" Text="Check for required software and modules." />

        <!-- PowerShell Version Info -->
        <Grid Margin="0,0,0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="PowerShell Version:" FontWeight="Medium" VerticalAlignment="Center"/>
            <TextBlock Grid.Column="1" Text="{Binding PowerShellVersion}" Margin="10,0,0,0" VerticalAlignment="Center" Height="38" TextWrapping="Wrap"/>
        </Grid>

        <!-- PowerCLI Status -->
        <Grid Margin="0,0,0,15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <TextBlock Grid.Column="0" Text="PowerCLI Status:" FontWeight="Medium" VerticalAlignment="Center"/>
            <TextBlock Grid.Column="1" Text="{Binding IsPowerCliInstalled, Converter={StaticResource BoolToStringConverter}, ConverterParameter=Installed;Not Installed}" Margin="10,0,10,0" VerticalAlignment="Center" Height="52"/>
            <ui:SymbolIcon Grid.Column="2" Symbol="{Binding IsPowerCliInstalled, Converter={StaticResource BoolToSymbolConverter}}" Foreground="{Binding IsPowerCliInstalled, Converter={StaticResource BoolToColorConverter}}" VerticalAlignment="Center"/>
        </Grid>

        <!-- Status Messages -->
        <TextBlock Text="{Binding PrerequisiteCheckStatus}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" TextWrapping="Wrap" Margin="0,0,0,10"/>
        <TextBlock Text="{Binding PowerCliInstallStatus}" Foreground="{DynamicResource TextFillColorSecondaryBrush}" TextWrapping="Wrap" Margin="0,0,0,10"/>

        <!-- Progress Bars -->
        <ProgressBar IsIndeterminate="True" Height="6" Margin="0,0,0,10" Visibility="{Binding IsCheckingPrerequisites, Converter={StaticResource BooleanToVisibilityConverter}}" />

        <!-- NEW: PowerCLI Installation Progress -->
        <!-- ENHANCED: PowerCLI Installation Progress Card -->
        <ui:Card Visibility="{Binding IsInstallingPowerCli, Converter={StaticResource BooleanToVisibilityConverter}}" 
         Margin="0,0,0,15" 
         Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header with Progress Ring -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,15">
                    <ui:ProgressRing Width="32" Height="32" IsIndeterminate="True" Margin="0,0,15,0"/>
                    <StackPanel>
                        <TextBlock Text="Installing PowerCLI" FontWeight="SemiBold" FontSize="16"/>
                        <TextBlock Text="Please wait while we download and install the VMware PowerCLI module" 
                           Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                           FontSize="12"/>
                    </StackPanel>
                </StackPanel>

                <!-- Current Status -->
                <TextBlock Grid.Row="1" 
                   Text="{Binding PowerCliInstallStatus}" 
                   Margin="0,0,0,10" 
                   TextWrapping="Wrap"
                   FontWeight="Medium"/>

                <!-- Progress Bar -->
                <ProgressBar Grid.Row="2" 
                     IsIndeterminate="True" 
                     Height="6" 
                     Margin="0,0,0,15"/>

                <!-- Installation Info -->
                <StackPanel Grid.Row="3">
                    <TextBlock Text="⏱️ Expected time: 3-5 minutes" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                       Margin="0,0,0,5"/>
                    <TextBlock Text="📦 Downloading: VMware.PowerCLI (~150MB)" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" 
                       Margin="0,0,0,5"/>
                    <TextBlock Text="🔗 Source: PowerShell Gallery" 
                       FontSize="12" 
                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </Grid>
        </ui:Card>
        <!-- Action Buttons -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
            <ui:Button Content="Check Prerequisites" 
                       Icon="{ui:SymbolIcon DocumentSearch24}" 
                       Command="{Binding CheckPrerequisitesCommand}" 
                       IsEnabled="{Binding IsCheckingPrerequisites, Converter={StaticResource InverseBooleanConverter}}" />

            <ui:Button Content="Install PowerCLI" 
                       Icon="{ui:SymbolIcon ArrowDownload24}" 
                       Margin="10,0,0,0" 
                       Command="{Binding InstallPowerCliCommand}" 
                       IsEnabled="{Binding IsInstallingPowerCli, Converter={StaticResource InverseBooleanConverter}}" 
                       Visibility="{Binding IsPowerCliInstalled, Converter={StaticResource InverseBooleanToVisibilityConverter}}">

                <!-- NEW: Button Content Template for Progress State -->
                <ui:Button.Style>
                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsInstallingPowerCli}" Value="True">
                                <Setter Property="Content" Value="Installing..."/>
                                <Setter Property="Icon" Value="{ui:SymbolIcon ArrowClockwise24}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:Button.Style>
            </ui:Button>
        </StackPanel>

        <!-- Success Message -->
        <ui:InfoBar Title="PowerCLI Ready!" 
                    Message="PowerCLI module is installed and ready to use." 
                    Severity="Success" 
                    IsOpen="{Binding IsPowerCliInstalled}" 
                    Margin="0,0,0,20" />

        <!-- NEW: Installation Progress InfoBar -->
        <ui:InfoBar Title="Installing PowerCLI" 
                    Message="Downloading and installing VMware PowerCLI module. This process may take several minutes depending on your internet connection." 
                    Severity="Informational" 
                    IsOpen="{Binding IsInstallingPowerCli}" 
                    Margin="0,0,0,20" />
    </StackPanel>
</UserControl>